---
{% set network_name = "zebr" ~ (project ~ stage) | hash | truncate(10, end="") ~ 0 %}
networks:
  - name: {{ network_name }}
    type: bridge
    config:
      ipv4.address: {{ "lxd-network-cidr" | lookup }}
      ipv4.nat: true
      ipv6.address: none
      dns.mode: dynamic

containers:
{% for container in "containers" | lookup | json %}
  - name: {{ project }}-{{ stage }}-{{ container.name }}
    source:
      type: image
      mode: pull
      server: https://cloud-images.ubuntu.com/daily
      protocol: simplestreams
      alias: bionic
    devices:
      root:
        type: disk
        path: /
        pool: default
      eth0:
        type: nic
        nictype: bridged
        parent: {{ network_name }}
        {% if container.ip %}ipv4.address: {{ container.ip }}{% endif %}
    config:
      user.user-data: |
        #cloud-config
        hostname: {{ container.name }}
        ssh_authorized_keys:
          - {{ "cat /home/ubuntu/.ssh/id_rsa.pub" | sh }}
        runcmd:
          - add-apt-repository -y ppa:zebr0/master
          - apt -y install zebr0-script
          - zebr0-init -u {{ url }} -p {{ project }} -s {{ stage }}
          - zebr0-script run {{ container.script }}
        power_state:
          mode: reboot
      boot.autostart: true
{% endfor %}
